---
title: "pixi.jsのshaderで遊ぶ"
date: "2021-06-05"
avatar: './pixijs.png'
---

# shaderのfilterの基本

## vertex shaderとfragmentshaderがある。
シェーダの流れ
javascript
↓
頂点シェーダ
↓
フラグメントシェーダ
↓
描画

```javascript
const vertex = `
    attribute vec2 aVertexPosition;
    attribute vec2 aTextureCoord;
    uniform mat3 projectionMatrix;
    //varyingはシェーダ間で渡す変数。fragmentにも
    //varying vec2 vTextureCoord;をフラグメントシェーダに定義することで渡される。
    varying vec2 vTextureCoord;
    void main(void){
        gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);
        vTextureCoord = aTextureCoord;
    }
`;

const fragment = `
    precision mediump float;//精度修飾子(どのくらいの精度でデータを扱うかを指定する)

    void main(){
        // 引数はRGBとα値
        // gl_FragColorは、フラグメントシェーダーの組み込み変数。
        gl_FragColor = vec4(1.0,1.0,1.0,0.5);
    }
`;
const myFilter = new PIXI.Filter(vertex, fragment, {});
app.stage.filters = [myFilter];
//以下のように後から追加設定が可能
//app.stage.filters.push(blurFilter);
```


# フラグメントシェーダで遊ぶ

## とりあえず加工せずに画像をそのまま表示させる。
フラグメントシェーダで無加工で画像を出力させるには以下の通りとなる。
```javascript
const fragment = `
    //精度修飾子(どのくらいの精度でデータを扱うかを指定する)
    precision mediump float;

    // テクスチャの座標（内部変数）
    varying vec2 vTextureCoord; 

    // フィルターを適用したテクスチャ画像（内部変数）
    uniform sampler2D uSampler;

    void main(){
        gl_FragColor = texture2D(uSampler, vTextureCoord);
    }
`;
```

### precision mediump float;とは？
どのくらいの精度でデータを扱うかを指定する。精度修飾子という。
mediumpより高くすると負荷が高くなるらしいから、mediump指定が一般的

### vTextureCoord
pixi.jsの内部変数。頂点シェーダから受け継いだデータ。テクスチャの座標が入っている。

### uSampler
pixi.jsの内部変数。フィルターで対象とした画像のテクスチャ

### gl_FragColor
gl_FragColorは描画用の組み込み変数。型はvec4


## 画像の座標を移動させる。

### 左に移動させる。
vTextureCoordを分解してx座標をいじってるだけ。
```javascript
const fragment = `
  precision mediump float;

  varying vec2 vTextureCoord; 

  uniform sampler2D uSampler;

  void main(){

    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + 0.02 , vTextureCoord.y));

  }
`;
```

### 左上に移動させる。
同じくy座標もいじってます。
```javascript
const fragment = `
  precision mediump float;

  varying vec2 vTextureCoord; 

  uniform sampler2D uSampler;

  void main(){

    // 以下のどちらの書き方でもOK.
    //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + 0.02 , vTextureCoord.y + 0.02));
    gl_FragColor = texture2D(uSampler, vTextureCoord.xy + 0.02 );
  }
`;
```


    

# backgroundに色を塗る
```javascript
const fragment = `
    precision mediump float;//精度修飾子(どのくらいの精度でデータを扱うかを指定する)
    void main(){
        // 引数はRGBとα値。
        vec4(0.5,0.5,0.5,0.0);
    }
`;
```


# backgroundに色を塗る
pixi.jsではvTextureCoordとuSamplerレンダリング情報が入っているので、
そこに赤を指定する。
```javascript
const fragment = `
    //精度修飾子(どのくらいの精度でデータを扱うかを指定する)
    precision mediump float;

    // テクスチャの座標（内部変数）
    varying vec2 vTextureCoord; 

    // フィルターを適用したテクスチャ画像（内部変数）
    uniform sampler2D uSampler;

    void main(){
        vec4 color = texture2D(uSampler, vTextureCoord);
        color.r = 0.5;
        gl_FragColor = color;
    }
`;
```

# グラデーションをつける。
組み込み変数 gl_FragCoord を介して、シェーダーが実行されているピクセルにアクセスできます。
```javascript
const fragment = `
    varying vec2 vTextureCoord;
    uniform sampler2D uSampler;

    void main(){
        vec4 color = texture2D(uSampler, vTextureCoord);
        //gl_FragCoordは、フラグメントシェーダーの組み込み変数。
        //描画領域内のどこで作業をしているかの情報、つまり座標を知ることができます。
        color.r = gl_FragCoord.x/1000.0;
        gl_FragColor = color;
    }
`;
```

# ガラスにうつったようにする。
```javascript
const fragment = `
  precision mediump float;

  varying vec2 vTextureCoord;//default Texture coords

  uniform sampler2D uSampler;//default texture

  uniform float uniform_float;//values are passeed from Pixi.js

  vec4 ColorUT;

  void main(){

    // fractは少数以下の値を返す。 x - floor(x)と等価
    ColorUT = texture2D(uSampler, fract(vTextureCoord+uniform_float));

    gl_FragColor = texture2D(uSampler, vTextureCoord+ColorUT.xy*0.02);
  }
`;
const myFilter = new PIXI.Filter(null, fragment, { uniform_float:0.0 });
app.stage.filters = [myFilter];
```


# セピア色にしてみる
vec4とmat3をかけた結果がイメージつかない。
```javascript
const fragment = `
uniform sampler2D uSampler;
varying vec2 vTextureCoord;
 
void main() {
  mat3 m = mat3(
    0.393, 0.769, 0.189,
    0.349, 0.686, 0.168,
    0.272, 0.534, 0.131);
  vec4 texel = texture2D(uSampler, vTextureCoord);
  gl_FragColor = vec4(texel.xyz * m, texel.w);
}
`;
```


# 輪郭抽出
```javascript
const fragment = `
uniform sampler2D uSampler;
varying vec2 vTextureCoord;
 
void main() {
  vec3 color = vec3(0.5, 0.5, 0.5);
  color += texture2D(uSampler, vTextureCoord).xyz * -4.0;
  color += texture2D(uSampler, vTextureCoord + vec2(-1.0/512.0, 0.0)).xyz;
  color += texture2D(uSampler, vTextureCoord + vec2( 1.0/512.0, 0.0)).xyz;
  color += texture2D(uSampler, vTextureCoord + vec2(0.0, -1.0/512.0)).xyz;
  color += texture2D(uSampler, vTextureCoord + vec2(0.0,  1.0/512.0)).xyz;
  color = step(0.55, color);
 
  gl_FragColor = vec4(color, 1.0);
}
`;
```


# てきすちゃを重ねて描画する。
https://jsfiddle.net/wzz7agmt/1/










